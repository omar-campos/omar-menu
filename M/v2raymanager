#!/bin/bash
cor1='\033[41;1;37m'
cor2='\033[44;1;37m'
scor='\033[0m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
SCOLOR='\033[0m'
msg01='\033[1;37m\033[1;33mUsuário Nulo\033[1;31m'
msg02='\033[1;37m\033[1;33mNome muito curto (MIN: 2 CHARACTERS)\033[1;31m'
msg03='\033[1;37m\033[1;33mNome muito grande (MAX: 5 CARACTERES)\033[1;31m'
msg04='\033[1;37m\033[1;33mSenha Nula\033[1;31m'
msg05='\033[1;37m\033[1;33mSenha muito curta\033[1;31m'
msg06='\033[1;37m\033[1;33mSenha muito grande\033[1;31m'
msg07='\033[1;37m\033[1;33mDuração Nula\033[1;31m'
msg08='\033[1;37m\033[1;33mDuração invalida, utilize números\033[1;31m'
msg09='\033[1;37m\033[1;33mDuração máxima de um ano\033[1;31m'
msg11='\033[1;37m\033[1;33mLimite Nulo\033[1;31m'
msg12='\033[1;37m\033[1;33mLimite invalido, utilize números\033[1;31m'
msg13='\033[1;37m\033[1;33mLimite máximo de 999\033[1;31m'
msg14='\033[1;37m\033[1;33mUsuario já Existe\033[1;31m'
msg15='\033[1;37m\033[1;33m(Apenas números) GB = Min: 1gb Max: 1000gb\033[1;31m'
msg16='\033[1;37m\033[1;33m(Apenas números)\033[1;31m'
msg17='\033[1;37m\033[1;33m(Sem imformação - Para Cancelar Digite CRTL + C)\033[1;31m'
    err_fun () {
        case $1 in
        1)msg -verm "$(fun_trans "Usuário Nulo")";
        sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        2)msg -verm "$(fun_trans "Nome muito curto (MIN: 2 CHARACTERS)")";
        sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        3)msg -verm "$(fun_trans "Nome muito grande (MAX: 5 CARACTERES)")";
        sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        4)msg -verm "$(fun_trans "Senha Nula")"; sleep 2s; tput cuu1;
        tput dl1; tput cuu1; tput dl1;;
        5)msg -verm "$(fun_trans "Senha muito curta")"; sleep 2s; tput cuu1; tput dl1; tput cuu1;
        tput dl1;;
        6)msg -verm "$(fun_trans "Senha muito grande")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        7)msg -verm "$(fun_trans "Duração Nula")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        8)msg -verm "$(fun_trans "Duração invalida, utilize números")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        9)msg -verm "$(fun_trans "Duração máxima de um ano")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        11)msg -verm "$(fun_trans "Limite Nulo")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        12)msg -verm "$(fun_trans "Limite invalido, utilize números")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        13)msg -verm "$(fun_trans "Limite máximo de 999")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        14)msg -verm "$(fun_trans "Usuario já Existe")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        15)msg -verm "$(fun_trans "(Apenas números) GB = Min: 1gb Max: 1000gb")"; sleep 2s; tput cuu1; tput dl1; tput cuu1;
	    tput dl1;;
	    16)msg -verm "$(fun_trans "(Apenas números)")"; sleep 2s; tput cuu1; tput dl1; tput cuu1; tput dl1;;
        17)msg -verm "$(fun_trans "(Sem imformação - Para Cancelar Digite CRTL + C)")"; sleep 4s; tput cuu1; tput dl1; tput cuu1;
        tput dl1;;
        esac
    }

    intallv2ray () {
	mkdir /etc/SSHPlus/v2ray
    apt install python3-pip -y 
    source <(curl -sL https://multi.netlify.app/v2ray.sh)
    echo -e "\033[1;37m\033[1;33mIntalado com Exito!\033[1;31m"
    USRdatabase="/etc/SSHPlus/RegV2ray"
    [[ ! -e ${USRdatabase} ]] && touch ${USRdatabase}
    sort ${USRdatabase} | uniq > ${USRdatabase}tmp
    mv -f ${USRdatabase}tmp ${USRdatabase}
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }

    protocolv2ray () {
    echo -e "\E[44;1;37m            ALTERAR PROTOCOLO V2RAY             \E[0m"
    echo -e "\033[1;37m• \033[1;33mEscolha a opção 3 e coloque o domínio do seu IP\033[1;31m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
   
    v2ray stream
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    tls () {
    clear
    echo -e "\E[44;1;37m            Ativar ou Desativar TLS             \E[0m"
    v2ray tls
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
 
    }
    portv () {
    echo -e "\E[44;1;37m            ALTERAR PORTA V2RAY             \E[0m"
    v2ray port
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    stats () {
    echo -e "\E[44;1;37m            ESTATÍSTICAS DE CONSUMO             \E[0m"
    v2ray stats
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    unistallv2 () {
    source <(curl -sL https://multi.netlify.app/v2ray.sh) --remove > /dev/null 2>&1
    rm -rf /etc/SSHPlus/RegV2ray > /dev/null 2>&1
	rm -rf /etc/SSHPlus/v2ray > /dev/null 2>&1
    echo -e "\n\033[1;32mV2RAY REMOVIDO COM SUCESSO !\033[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    infocuenta () {
    echo -e "\E[44;1;37m            INFORMAÇÃO DE CONTA             \E[0m"
    v2ray info
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    # ==================== CREAR USUARIO (NUNCA SE CIERRA) ====================
addusr () {
    clear
   
    echo -e "\E[44;1;37m          ➤ ADICIONAR USUARIO UUID V2RAY ➤         \E[0m\n"

    while true;
    do
        # UUID automático o manual
        echo -e "\033[1;33m[1]\033[0m UUID Automático"
        echo -e "\033[1;33m[2]\033[0m UUID Manual"
        echo -e "\033[1;31m[0]\033[0m Volver al menú principal"
        echo -ne "\n\033[1;37mElige una opción: \033[1;92m"
        read opc
        [[ "$opc" = "0" ]] && fun_v2raymanager

        case "$opc" in
    
            1) UUID=$(uuidgen)
               echo -e "\n\033[1;32mUUID generado automáticamente:\033[1;97m $UUID\033[0m";
               TIPO="auto";;
            2) echo -ne "\n\033[1;37mPega tu UUID manual: \033[1;92m"
               read UUID
               [[ -z "$UUID" ]] && echo -e "\033[1;31m✗ UUID vacío\033[0m" && continue
               # VALIDAR DUPLICADO
               if grep -q "^$UUID|" /etc/SSHPlus/RegV2ray 2>/dev/null || grep -q "\"id\": \"$UUID\"" /etc/v2ray/config.json 2>/dev/null; then
                   echo -e "\n\033[1;31m✗ ERROR: Este UUID ya existe en el servidor!\033[0m"
                   echo -e "   No se permite duplicado.\n"
                   sleep 3
               
                   clear
                   echo -e "\E[44;1;37m          ➤ ADICIONAR USUARIO UUID V2RAY ➤         \E[0m\n"
                   continue
               fi
               echo -e "\n\033[1;32mUUID aceptado:\033[1;97m $UUID\033[0m";
               TIPO="manual";;
            *) echo -e "\033[1;31m✗ Opción inválida\033[0m" && continue;;
        esac

        # Nick
        while :;
        do
            echo -ne "\n\033[1;37mNombre de usuario (nick): \033[1;92m"
            read nick
            nick=$(echo "$nick" | sed 's/[^a-zA-Z0-9 -]//g' | xargs)
            [[ ${#nick} -ge 2 && ${#nick} -le 20 ]] && break
            echo -e "\033[1;31m✗ Entre 2 y 20 caracteres\033[0m"
        done

 
        # Días
        while :;
        do
            echo -ne "\n\033[1;37mDías de validez (1-360): \033[1;92m"
            read diasuser
            [[ "$diasuser" =~ ^[0-9]+$ && "$diasuser" -ge 1 && "$diasuser" -le 360 ]] && break
            echo -e "\033[1;31m✗ Valor inválido\033[0m"
        done

        valid=$(date '+%C%y-%m-%d' -d "+$diasuser days")
       
        datexp=$(date "+%d/%m/%Y" -d "+$diasuser days")
        mailito=$(cat /dev/urandom | tr -dc 'a-z0-9' | head -c 10)

        # Añadir al config.json (más seguro que el método viejo)
        sed -i '/"clients": \[/a\            {\n                "id": "'"$UUID"'",\n                "alterId": 0,\n                "email": "'"$mailito"'@gmail.com"\n            },' /etc/v2ray/config.json

        # Registrar: AÑADIDO TIPO (auto/manual)
        echo "$UUID|$nick|$valid|$TIPO" >> /etc/SSHPlus/RegV2ray

        # Reiniciar
        v2ray restart >/dev/null 2>&1

        clear
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "      
            \033[1;92mUSUARIO CREADO CON ÉXITO ✓\033[0m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e " UUID     → \033[1;97m$UUID\033[0m"
        echo -e " Usuario  → \033[1;97m$nick\033[0m"
        echo -e " Tipo     → \033[1;97m$TIPO\033[0m"
        echo -e " Expira   → \033[1;97m$datexp\033[0m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37mPresiona Enter para continuar...\033[0m"
        read && break
    
    done
    fun_v2raymanager
}
    delusr () {
    clear 
    clear
    invaliduuid () {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\e[91m                    UUID INVALIDO \n"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            ELIMINAR USUARIO | UUID V2RAY             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\e[97m               USUARIOS REGISTRADOS"
    echo -e "\e[33m$(cat /etc/SSHPlus/RegV2ray|cut -d '|' -f2,1)" 
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -ne "\e[91m >> Digita UUID para eliminar:\n \033[1;92m " && read uuidel
    [[ $(sed -n '/'${uuidel}'/=' /etc/v2ray/config.json|head -1) ]] || invaliduuid
    lineP=$(sed -n '/'${uuidel}'/=' /etc/v2ray/config.json)
    linePre=$(sed -n '/'${uuidel}'/=' /etc/SSHPlus/RegV2ray)
    sed -i "${linePre}d" /etc/SSHPlus/RegV2ray
    numl1=2
    let resta=$lineP-$numl1
    sed -i "${resta}d" /etc/v2ray/config.json
    sed -i "${resta}d" /etc/v2ray/config.json
    sed -i "${resta}d" /etc/v2ray/config.json
    sed -i "${resta}d" /etc/v2ray/config.json
    sed -i "${resta}d" /etc/v2ray/config.json
    v2ray restart > /dev/null 2>&1
    echo ""
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\e[92m           UUID ELIMINADO COM EXITO "
  
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }

    mosusr_kk() {
    clear 
    clear
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            USUARIOS REGISTRADOS | UUID V2RAY             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    # usersss=$(cat /etc/SSHPlus/RegV2ray|cut -d '|' -f1)
    # cat /etc/SSHPlus/RegV2ray|cut -d'|'
    # Se añade la columna TIPO (4to campo)
    VPSsec=$(date +%s)
    local HOST="/etc/SSHPlus/RegV2ray"
    local HOST2="/etc/SSHPlus/RegV2ray"
    local RETURN="$(cat $HOST|cut -d'|' -f2)"
    local IDEUUID="$(cat $HOST|cut -d'|' -f1)"
    if [[ -z $RETURN ]]; then
    echo -e "----- NENHUM USUARIO REGISTRADO -----"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    else
    i=1
    echo -e "\e[97m                 UUID               | USER | TIPO | EXPIRACION \e[93m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    while read hostreturn ; do
    DateExp="$(cat /etc/SSHPlus/RegV2ray|grep -w "$hostreturn"|cut -d'|' -f3)"
    Tipo="$(cat /etc/SSHPlus/RegV2ray|grep -w "$hostreturn"|cut -d'|' -f4)"
    if [[ ! -z $DateExp ]]; then             
    DataSec=$(date +%s --date="$DateExp")
    [[ "$VPSsec" -gt "$DataSec" ]] && EXPTIME="\e[91m[EXPIRADO]\e[97m" || EXPTIME="\e[92m[$(($(($DataSec - $VPSsec)) / 86400))]\e[97m Dias"
    else
    EXPTIME="\e[91m[ S/R ]"
    fi 
    usris="$(cat /etc/SSHPlus/RegV2ray|grep -w "$hostreturn"|cut -d'|' -f2)"
    local contador_secuencial+="\e[93m$hostreturn \e[97m|\e[93m$usris\e[97m|\e[93m$Tipo\e[97m|\e[93m $EXPTIME \n"          
          if [[ $i -gt 30 ]]; then
    	      echo -e "$contador_secuencial"
    	  unset contador_secuencial
    	  unset i
    	  fi
    let i++
    done <<< "$IDEUUID"
    [[ ! -z $contador_secuencial ]] && {
    linesss=$(cat /etc/SSHPlus/RegV2ray | wc -l)
    	      
    echo -e "$contador_secuencial \n Numero de Registrados: $linesss"
    	}
    fi
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }

    # ==================== NUEVAS FUNCIONES DE EDICIÓN ====================

    edit_days () {
        local OLD_UUID="$1"
        local NICK="$2"
        local TIPO="$3"
        
        while :; do
            echo -ne "\n\033[1;37mNuevos días de validez (1-360): \033[1;92m"
            read diasuser
            [[ "$diasuser" =~ ^[0-9]+$ && "$diasuser" -ge 1 && "$diasuser" -le 360 ]] && break
            echo -e "\033[1;31m✗ Valor inválido\033[0m"
        done
        
        local valid=$(date '+%C%y-%m-%d' -d "+$diasuser days")
        local datexp=$(date "+%d/%m/%Y" -d "+$diasuser days")
        
        # El registro ahora tiene 4 campos: UUID|NICK|EXPIRA|TIPO
        local NEW_LINE="${OLD_UUID}|${NICK}|${valid}|${TIPO}"
        
        # Reemplazar la línea en la base de datos
        local linePre=$(sed -n '/'${OLD_UUID}'/=' /etc/SSHPlus/RegV2ray)
        sed -i "${linePre}c\\${NEW_LINE}" /etc/SSHPlus/RegV2ray
        
        clear
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "         \033[1;92mDIAS DE VALIDEZ ACTUALIZADOS ✓\033[0m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e " Usuario  → \033[1;97m$NICK\033[0m"
        echo -e " Expira   → \033[1;97m$datexp\033[0m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37mPresiona Enter para continuar...\033[0m"
        read
        fun_v2raymanager
    }

    edit_uuid () {
        local OLD_UUID="$1"
        local NICK="$2"
        local TIPO="$3"
        
        while :; do
            echo -ne "\n\033[1;37mPega el nuevo UUID manual: \033[1;92m"
            read NEW_UUID
            [[ -z "$NEW_UUID" ]] && echo -e "\033[1;31m✗ UUID vacío\033[0m" && continue

            # Validar duplicado del nuevo UUID
            if grep -q "^$NEW_UUID|" /etc/SSHPlus/RegV2ray 2>/dev/null || grep -q "\"id\": \"$NEW_UUID\"" /etc/v2ray/config.json 2>/dev/null; then
                echo -e "\n\033[1;31m✗ ERROR: Este UUID ya existe en el servidor!\033[0m"
                sleep 2
                continue
            fi
            break
        done

        # Paso 1: Eliminar el viejo UUID del config.json (Similar a delusr)
        local lineP=$(sed -n '/'${OLD_UUID}'/=' /etc/v2ray/config.json|head -1)
        local numl1=2
        local resta=$lineP-$numl1
        sed -i "${resta}d" /etc/v2ray/config.json # Eliminar '{'
        sed -i "${resta}d" /etc/v2ray/config.json # Eliminar id
        sed -i "${resta}d" /etc/v2ray/config.json # Eliminar alterId
        sed -i "${resta}d" /etc/v2ray/config.json # Eliminar email
        sed -i "${resta}d" /etc/v2ray/config.json # Eliminar '},'

        # Paso 2: Añadir el nuevo UUID al config.json (Similar a addusr)
        local mailito=$(cat /dev/urandom | tr -dc 'a-z0-9' | head -c 10)
        sed -i '/"clients": \[/a\            {\n                "id": "'"$NEW_UUID"'",\n                "alterId": 0,\n                "email": "'"$mailito"'@gmail.com"\n            },' /etc/v2ray/config.json

        # Paso 3: Actualizar la base de datos /etc/SSHPlus/RegV2ray
        local EXPIRA=$(grep -w $OLD_UUID /etc/SSHPlus/RegV2ray | cut -d'|' -f3) # Mantener la misma expiración
        local NEW_LINE="${NEW_UUID}|${NICK}|${EXPIRA}|${TIPO}"
        local linePre=$(sed -n '/'${OLD_UUID}'/=' /etc/SSHPlus/RegV2ray)
        sed -i "${linePre}c\\${NEW_LINE}" /etc/SSHPlus/RegV2ray
        
        # Paso 4: Reiniciar V2Ray
        v2ray restart >/dev/null 2>&1

        clear
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "       \033[1;92mUUID ACTUALIZADO CON ÉXITO ✓\033[0m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e " Nuevo UUID → \033[1;97m$NEW_UUID\033[0m"
        echo -e " Usuario    → \033[1;97m$NICK\033[0m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37mPresiona Enter para continuar...\033[0m"
        read
        fun_v2raymanager
    }

    editusr () {
        clear
        echo -e "\E[44;1;37m          ➤ EDITAR USUARIO UUID V2RAY ➤          \E[0m\n"
        
        # Muestra los usuarios registrados
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\e[97m               USUARIOS REGISTRADOS"
        echo -e "\e[33m$(cat /etc/SSHPlus/RegV2ray|cut -d '|' -f2,1)"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

        echo -ne "\e[91m >> Digita UUID del usuario a editar:\n \033[1;92m "
        read uaidedit
        
        # 1. Validar si el UUID existe
        if ! grep -q "^${uaidedit}|" /etc/SSHPlus/RegV2ray; then
            echo -e "\n\033[1;31m✗ ERROR: UUID no encontrado.\033[0m"
            sleep 2
            fun_v2raymanager
            return
        fi

        # Extraer datos del usuario actual
        TIPO=$(grep -w $uaidedit /etc/SSHPlus/RegV2ray | cut -d'|' -f4) # auto/manual
        NICK=$(grep -w $uaidedit /etc/SSHPlus/RegV2ray | cut -d'|' -f2)
        EXPIRA=$(grep -w $uaidedit /etc/SSHPlus/RegV2ray | cut -d'|' -f3)

        while true; do
            clear
            echo -e "\E[44;1;37m          ➤ EDITAR USUARIO UUID V2RAY ➤          \E[0m\n"
            echo -e "UUID: \033[1;97m$uaidedit\033[0m"
            echo -e "Nick: \033[1;97m$NICK\033[0m"
            echo -e "Tipo: \033[1;97m$TIPO\033[0m"
            echo -e "Vence: \033[1;97m$EXPIRA\033[0m"
            echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
            echo -e "\033[1;33m[1]\033[0m Editar Días de Vencimiento"
            
            # LÓGICA CONDICIONAL: SOLO MUESTRA la opción si es 'manual'
            [[ "$TIPO" = "manual" ]] && echo -e "\033[1;33m[2]\033[0m Cambiar UUID (Solo si es Manual)"
            
            echo -e "\033[1;31m[0]\033[0m Volver al menú principal"
            echo -ne "\n\033[1;37mElige una opción: \033[1;92m"
            read opc_edit

            case "$opc_edit" in
                1) edit_days "$uaidedit" "$NICK" "$TIPO"; break;;
                # LÓGICA CONDICIONAL: SOLO EJECUTA si es 'manual'
                2) [[ "$TIPO" = "manual" ]] && edit_uuid "$uaidedit" "$NICK" "$TIPO"; break || echo -e "\033[1;31m✗ Opción inválida. No se puede editar un UUID automático.\033[0m" && sleep 2;;
                0) fun_v2raymanager; return;;
                *) echo -e "\033[1;31m✗ Opción inválida.\033[0m" && sleep 1;;
            esac
        done
    }

    # ==================== FIN NUEVAS FUNCIONES DE EDICIÓN ====================

    lim_port () {
    clear 
    clear
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            LIMITAR MB X PORT | UUID V2RAY             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    ###VER
    estarts () {
    VPSsec=$(date +%s)
    local HOST="/etc/SSHPlus/v2ray/lisportt.log"
    local HOST2="/etc/SSHPlus/v2ray/lisportt.log"
    local RETURN="$(cat $HOST|cut -d'|' -f2)"
    local IDEUUID="$(cat $HOST|cut -d'|' -f1)"
    if [[ -z $RETURN ]]; then
    echo -e "----- NENHUMA PORTA REGISTRADA -----"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    
    else
    i=1
    while read hostreturn ; do
    iptables -n -v -L > /etc/SSHPlus/v2ray/data1.log 
    statsss=$(cat /etc/SSHPlus/v2ray/data1.log|grep -w "tcp spt:$hostreturn quota:"|cut -d' ' -f3,4,5)
    gblim=$(cat /etc/SSHPlus/v2ray/lisportt.log|grep -w "$hostreturn"|cut -d'|' -f2)
    local contador_secuencial+="         \e[97mPUERTO: \e[93m$hostreturn \e[97m|\e[93m$statsss \e[97m|\e[93m $gblim GB  \n"          
          if [[ $i -gt 30 ]]; then
    	      
    echo -e "$contador_secuencial"
    	  unset contador_secuencial
    	  unset i
    	  fi
    let i++
    done <<< "$IDEUUID"
    [[ ! -z $contador_secuencial ]] && {
    linesss=$(cat /etc/SSHPlus/v2ray/lisportt.log | wc -l)
    	      echo -e "$contador_secuencial \n Puertos Limitados: $linesss"
    	}
    fi
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager 
    }
    ###LIM
    liport () {
    while true;
    do
         echo -ne "\e[91m >> Digite Port a Limitar:\033[1;92m " && read portbg
         if [[ -z "$portbg" ]];
    then
         echo -e "$msg17" && continue
         elif [[ "$portbg" != +([0-9]) ]];
    then
         echo -e "$msg16" && continue
         elif [[ "$portbg" -gt "1000" ]];
    then
         echo -e "$msg16" && continue
         fi 
         break
    done
    while true;
    do
         echo -ne "\e[91m >> Digite Cantidad de GB:\033[1;92m " && read capgb
         if [[ -z "$capgb" ]];
    then
         echo -e "$msg17" && continue
         elif [[ "$capgb" != +([0-9]) ]];
    then
         echo -e "$msg15" && continue
         elif [[ "$capgb" -gt "1000" ]];
    then
         echo -e "$msg15" && continue
         fi 
         break
    done
    uml1=1073741824
    gbuser="$capgb"
    let multiplicacion=$uml1*$gbuser
    sudo iptables -I OUTPUT -p tcp --sport $portbg -j DROP
    sudo iptables -I OUTPUT -p tcp --sport $portbg -m quota --quota $multiplicacion -j ACCEPT
    iptables-save > /etc/iptables/rules.v4
    echo ""
    echo -e " Porta Selecionada: $portbg | Quantidade de GB: $gbuser"
    echo ""
    echo " $portbg | $gbuser | $multiplicacion " >> /etc/SSHPlus/v2ray/lisportt.log 
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    ###RES
    resdata () {
    VPSsec=$(date +%s)
    local HOST="/etc/SSHPlus/v2ray/lisportt.log"
    local HOST2="/etc/SSHPlus/v2ray/lisportt.log"
    local RETURN="$(cat $HOST|cut -d'|' -f2)"
    local IDEUUID="$(cat $HOST|cut -d'|' -f1)"
    if [[ -z $RETURN ]];
    then
    echo -e "----- NENHUMA PORTA REGISTRADA -----"
    return 0
    else
    i=1
    while read hostreturn ;
    do
    iptables -n -v -L > /etc/SSHPlus/v2ray/data1.log 
    statsss=$(cat /etc/SSHPlus/v2ray/data1.log|grep -w "tcp spt:$hostreturn quota:"|cut -d' ' -f3,4,5)
    gblim=$(cat /etc/SSHPlus/v2ray/lisportt.log|grep -w "$hostreturn"|cut -d'|' -f2)
    local contador_secuencial+="         \e[97mPUERTO: \e[93m$hostreturn \e[97m|\e[93m$statsss \e[97m|\e[93m $gblim GB  \n"  
            
          if [[ $i -gt 30 ]];
    then
    	      echo -e "$contador_secuencial"
    	  unset contador_secuencial
    	  unset i
    	  fi
    let i++
    done <<< "$IDEUUID"

    [[ ! -z $contador_secuencial ]] && {
    linesss=$(cat /etc/SSHPlus/v2ray/lisportt.log | wc -l)
    	      echo -e "$contador_secuencial \n Puertos Limitados: $linesss"
    	}
    fi
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

    while true;
    do
         echo -ne "\e[91m >> Digite Puerto a Limpiar:\033[1;92m " && read portbg
         if [[ -z "$portbg" ]];
    then
         echo -e "$msg17" && continue
         elif [[ "$portbg" != +([0-9]) ]];
    then
         echo -e "$msg16" && continue
         elif [[ "$portbg" -gt "1000" ]];
    then
         echo -e "$msg16" && continue
         fi 
         break
    done
    invaliduuid () {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\e[91m                PORTA INVALIDA \n"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
  
    [[ $(sed -n '/'${portbg}'/=' /etc/SSHPlus/v2ray/lisportt.log|head -1) ]] || invaliduuid
    gblim=$(cat /etc/SSHPlus/v2ray/lisportt.log|grep -w "$portbg"|cut -d'|' -f3)
    sudo iptables -D OUTPUT -p tcp --sport $portbg -j DROP
    sudo iptables -D OUTPUT -p tcp --sport $portbg -m quota --quota $gblim -j ACCEPT
    iptables-save > /etc/iptables/rules.v4
    lineP=$(sed -n '/'${portbg}'/=' /etc/SSHPlus/v2ray/lisportt.log)
    sed -i "${lineP}d" /etc/SSHPlus/v2ray/lisportt.log
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager
    }
    ## MENU
    echo -e "\033[1;37m\033[1;33m[1] > LIMITAR DADOS x PORTA\033[1;31m"
    echo -e "\033[1;37m\033[1;33m[2] > RESETAR DADOS DE PORTA\033[1;31m"
    echo -e "\033[1;37m\033[1;33m[3] > VER DATOS CONSUMIDOS\033[1;31m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;32m [0] > \e[97m\033[1;41m VOLTAR \033[1;37m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    selection=$(selection_fun 3)
    case ${selection} in
    1)liport ;;
    2)resdata;;
    3)estarts;;
    0)
    fun_v2raymanager
    ;;
    esac
    }

    #.
    limpiador_activador () {
    unset PIDGEN
    PIDGEN=$(ps aux|grep -v grep|grep "limv2ray")
    if [[ ! $PIDGEN ]]; then
    screen -dmS limv2ray watch -n 21600 limv2ray
    else
    #killall screen
    screen -S limv2ray -p 0 -X quit
    fi
    unset PID_GEN
    PID_GEN=$(ps x|grep -v grep|grep "limv2ray")
    [[ ! $PID_GEN ]] && PID_GEN="\e[91m ✕  " || PID_GEN="\e[92m ✓  "
    statgen="$(echo $PID_GEN)"
    clear 
    clear
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            ELIMINAR EXPIRADOS | UUID V2RAY             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo ""
    echo -e "                 $statgen " 
    echo "" 						
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_v2raymanager

    }

    selection_fun () {
    local selection="null"
    local range
    for((i=0; i<=$1; i++));
    do range[$i]="$i "; done
    while [[ ! $(echo ${range[*]}|grep -w "$selection") ]];
    do
    echo -ne "\033[1;37m ► Selecione uma Opção: " >&2
    read selection
    tput cuu1 >&2 && tput dl1 >&2
    done
    echo $selection
    }

    PID_GEN=$(ps x|grep -v grep|grep "limv2ray")
    [[ ! $PID_GEN ]] && PID_GEN="\e[91m✕  " || PID_GEN="\e[92m✓  "
    statgen="$(echo $PID_GEN)"
    #SPR & 
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

    fun_v2raymanager() {
		while true $x != "ok";
		do
			clear
			echo -e "\033[0;34m┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓\033[0m"
			echo -e "\033[0;34m┃\E[44;1;37m            GERENCIADOR V2RAY            \E[0m\033[0;34m┃"
			echo -e "\033[0;34m┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛\033[0m"

			xv2ray1=`if netstat -tunlp |grep v2ray 1> /dev/null 2> /dev/null;
			then
			echo -e "\e[92m ATIVADO"
			else
			echo -e "\e[91m DESATIVADO"
			fi`;
            echo -e "\033[1;32mSERVICO: \033[1;33mV2RAY \033[1;32m$xv2ray1\033[1;37m" 
			xv2ray=`if netstat -tunlp |grep v2ray 1> /dev/null 2> /dev/null;
			then
			echo -e "\033[1;32m✓ "
			else
			echo -e "\033[1;31m✕ "
			fi`;          
			echo -e "\033[0;34m┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓\033[0m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m01\033[1;31m] \033[1;37m• \033[1;37mINSTALAR V2RAY $xv2ray                 \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m02\033[1;31m] \033[1;37m• \033[1;37mALTERAR PROTOCOLO                 \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m03\033[1;31m] \033[1;37m• \033[1;37mATIVAR TLS                        \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m04\033[1;31m] \033[1;37m• \033[1;37mALTERAR PORTA V2RAY               \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m05\033[1;31m] \033[1;37m• \033[1;37mADICIONAR USUARIO UUID            \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m06\033[1;31m] \033[1;37m• \033[1;37mELIMINAR USUARIO UUID             \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m07\033[1;31m] \033[1;37m• \033[1;37mMOSTAR USUARIOS REGISTRADOS       \033[0;34m"
            echo -e "\033[0;34m┃\033[1;31m[\033[1;36m08\033[1;31m] \033[1;37m• \033[1;37mEDITAR USUARIO UUID               \033[0;34m"
            echo -e "\033[0;34m┃\033[1;31m[\033[1;36m09\033[1;31m] \033[1;37m• \033[1;37mINFORMAÇÃO DA CONTA               \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m10\033[1;31m] \033[1;37m• \033[1;37mESTATÍSTICAS DE CONSUMO           \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m11\033[1;31m] \033[1;37m• \033[1;37mLIMITADOR POR CONSUMO             \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m12\033[1;31m] \033[1;37m• \033[1;37mLIMPADOR DE EXPIRADOS $statgen    \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m13\033[1;31m] \033[1;37m• \033[1;37mDESINSTALAR V2RAY                 \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m14\033[1;31m] \033[1;37m• \033[1;37mVOLTAR \033[1;32m<\033[1;33m<\033[1;31m<          \033[0;34m"
			echo -e "\033[0;34m┃\033[1;31m[\033[1;36m00\033[1;31m] \033[1;37m• \033[1;37mSAIR \033[1;32m<\033[1;33m<\033[1;31m<               \033[0;34m"
			echo -e "\033[0;34m┗┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛\033[0m"
			tput civis
			echo -ne "\033[0;34m ┗╼\033[1;32mOQUE DESEJA FAZER \033[1;37m?\033[1;31m?\033[1;37m: "
			read x
			tput cnorm
			clear
			case $x in
			1 | 01)
				intallv2ray
				;;
			2 | 02)
				protocolv2ray
				;;
			3 | 03)
				tls
				;;
			4 | 04)
				portv
				;;
			5 | 05)
				addusr
				;;
			6 | 06)
				delusr
				;;
			7 | 07)
				mosusr_kk
				;;
            8 | 08)
                editusr
                ;;
            9 | 09)
				infocuenta
                ;;
			10 | 10)
				stats
				;;
		    11 | 11)
				lim_port
				;;                
			12 | 12)
				limpiador_activador
				;;
            13 | 13)
				unistallv2
				;;
            14 | 14)
				conexao
                exit;
				;;
			0 | 00)
				echo -e "\033[1;31mSaindo...\033[0m"
				sleep 2
				clear
				exit
				;;
			*)
				echo -e "\033[1;31mOpcao invalida !\033[0m"
				sleep 2
				;;
			esac
		done
	}
    fun_v2raymanager
